<h1>Диалоговое Bot API</h1>  
Данный репозиторий является Docker образом, который можно развернуть на локальной или удаленной машине.

- <b>/bot/</b> - Папка и исходным кодом бота.
- <b>/mysql-dump/</b> - Папка со всеми SQL файлами. Создание таблиц и популяция данных.

## Инструкция по развертыванию 

Первым делом, убедитесь что у вас установлен  `docker` и `docker-compose` . Подробную инструкцию установки его на вашу операционную систему можно найти на [официальном сайте](https://docs.docker.com/engine/install/). 
- Рекомендуемая версия, на которой собирался образ - <b>20.10.12</b>

В папку с вашим будущем проектом клонируйте репозиторий.
```bash
git clone https://github.com/Ezil15/bot_api_docker_project.git
````

Сначала необходимо настроить <b>docker-compose.yaml</b>, он лежит в корневой папке проекта. 
Необходимо задать переменные среды для нашей будущей базы данных.
В файле <b>docker-compose.yaml</b> найдите следующий код и измените его под ваши нужды.
```csharp
db:
    image: mysql:5.7.16
    restart: always
    environment:
      MYSQL_DATABASE: 'db' #Имя базы
      MYSQL_USER: 'user' #Имя пользователя
      MYSQL_PASSWORD: 'password' #Пароль
      MYSQL_ROOT_PASSWORD: 'password' #Рут пароль
      LANG: 'C.UTF-8'
```

Далее, откройте любой клиент поддерживающий команду `docker` в корнейвой папке с вашим проектом и напишите
```bash
docker-compose -f docker-compose.yaml up -d
```
Данная команда соберет и создаст три разных контейнера под одной сетью. 
- app - Контейнер с ботом.
- db - Контейнер с базой данных.
- nginx - Контейнер c веб сервером

Если вы запускали проект на локальной машине, то при переходе на страницу [localhost:8080/dialogue?user_id=1&message=/start](http://localhost:8080/dialogue?user_id=1&message=/start) вы увидите базовый ответ от бота.
```
{"user_id":1,"answer_id":0,"response_text":"Привет! Я помогу отличить кота от хлеба! Объект перед тобой квадратный?","to_dialogue":1}
```

## Документация к API
| Path | Returns | Params |
| ------ | ------ | ------ |
| /dialogue | Возвращает json c ответом от бота на переданное сообщение |{user_id} {message} |
| /last_messages | Возвращает json cо списком последних сообщений отправленных пользователем |{user_id} {count} |



<h3>/dialogue</h3>
Через этот запрос осуществляется общение с ботом.
Данный запрос принимает один обязательный параметр `user_id` и один необязательный `message`. 
- `user_id` - Айди пользователя от лица которого видется общения в ботом. (Если пользователя не сущестовало, то он создастся автоматически)
- `message` - Сообщение пользователя боту. По умолчанию `message=/start`, что является стартом диалога с ботом.

<h4>Пример использования</h4> 

Запрос `http://localhost:8080/dialogue?user_id=1&message=/start` вернет нам JSON файл со следующим содержимым.

```json
{
  "user_id": 1,
  "answer_id": 0,
  "response_text": "Привет! Я помогу отличить кота от хлеба! Объект перед тобой квадратный?",
  "to_dialogue": 1
}
```

Последующий запрос `http://localhost:8080/dialogue?user_id=1&message=Конечно!` вернет нам

```json
{
  "user_id": 1,
  "answer_id": 1,
  "response_text": "У него есть уши?",
  "to_dialogue": 2
}
```

И наконец еще один запрос `http://localhost:8080/dialogue?user_id=1&message=Уверен что да` вернет нам

```json
{
  "user_id": 1,
  "answer_id": 1,
  "response_text": "Это кот, а не хлеб! Не ешь его!",
  "to_dialogue": 3
}
```

<h3>/last_messages</h3>

Запрос позволяет получить последние сообщения, отправленные пользователем `user_id` через запрос /dialogue
Данный запрос принимает один обязательный параметр `user_id` и один необязательный `count`. 

- `user_id` - Айди пользователя, чью историю переписки мы хотим получить.
- `count` - Количество сообщений, которые мы хотим получить. По умолчанию `count=10`

<h4>Пример использования</h4> 

Запрос `http://localhost:8000/last_messages?user_id=1` вернет JSON файл следующего рода:

```json
{
  "user_id": 1,
  "count": 10,
  "data": [
     {
      "log_id": 3,
      "answer_id": 1,
      "sended_text": "Уверен что да",
      "from_dialogue": 2,
      "to_dialogue": 3,
      "send_date": "2022-12-02T16:44:12"
    },
    {
      "log_id": 2,
      "answer_id": 1,
      "sended_text": "Конечно!",
      "from_dialogue": 2,
      "to_dialogue": 3,
      "send_date": "2022-12-02T16:41:03"
    },
    {
      "log_id": 1,
      "answer_id": 0,
      "sended_text": "/start",
      "from_dialogue": 0,
      "to_dialogue": 1,
      "send_date": "2022-12-02T16:41:11"
    }
  ]
}
```
